#!/usr/bin/env python

import argparse, string, os, fileinput, glob, json

def readDirectory(args):
	path = args.tracefile
	sparse = args.sparse
	listing = glob.glob(os.path.join(path, 'tracefile*'))
	mapping = args.syscall_mapping
	for infile in listing:
		finput = fileinput.input([infile])
		if sparse:
			vector = vectorizeSparse(finput,True)
		else:
			vector = vectorizeComplete(finput,mapping,True)
		if args.libsvmformat:
			printLibSVMFormatted(vector)
		elif args.plainformat:
			printPlainFormatted(vector)	
		finput.close()

def readSyscallMapping(mapfile):
	syscall_nrs = {}
	mapping = open(mapfile,'r')
	for line in mapping:
		syscall = string.split(line,":")[0]
		syscall_nr = int(string.split(line,":")[1].rstrip())
		if syscall not in syscall_nrs.keys():
			syscall_nrs[syscall] = syscall_nr
	mapping.close()
	return syscall_nrs

def vectorizeSparse(path,directory):
	sparseCalls = ['exit','read','write','open','close','brk','ioctl','sendto','sendmsg','recvfrom','recvmsg'] 
	vector = [0]*len(sparseCalls)
	if directory:
		tracefile = path
	else:
		tracefile = fileinput.input(path)
	for line in tracefile:
		syscall = string.split(line,'(')[0]
		if syscall in sparseCalls:
			vector[sparseCalls.index(syscall)] += 1
	return vector

def vectorizeComplete(path,mapfile,directory):
	mapping = readSyscallMapping(mapfile)
	maplist = list()
	for i in sorted(mapping.items(), key=lambda x:x[1]):
		maplist.append(i[0])
	vector = [0]*len(maplist) 
	if directory:
		tracefile = path
	else:
		tracefile = fileinput.input(path)
	for line in tracefile:
		syscall = string.split(line,'(')[0]
		if syscall in maplist:
			vector[int(maplist.index(syscall))] += 1
	return vector 

def main():

        #tofind = [143, 147, 241, 121, 46, 55, 264] # libsvm 7
        #tofind = [143, 147, 241, 121, 46, 55, 264, 200, 253, 225, 21, 181] # libsvm 12 
        #tofind = [12,64,68,145,173,192,241,249] #weka 8 
	sparseCalls = ['exit','read','write','open','close','brk','ioctl','sendto','sendmsg','recvfrom','recvmsg'] 

        #tofind = [241, 126, 405, 127, 193, 92, 293] # libsvm netsentry
        mapping = readSyscallMapping("../syscall_matching_arm")

        maplist = list()
        for i in sorted(mapping.items(), key=lambda x:x[1]):
                maplist.append(i[0])

        #print maplist

        for item in tofind:
            print item , " -> ", maplist[item-1]


        #with open("../unused_features_names.json",'r') as infile:
        #    unused_feats = json.load(infile)

        #for item in unused_feats:
        #    del mapping[item]
    
        maplist_seq = list()
        for i in sorted(mapping.items(), key=lambda x:x[1]):
            maplist_seq.append(i[0])

        #with open('sequence_mapping.json','w') as outfile:
        #    json.dump(maplist_seq,outfile)

if __name__ == "__main__":
	main()
