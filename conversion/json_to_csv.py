#!/usr/bin/env python

import argparse, string, os, json 
from sklearn import preprocessing
def help():
	parser = argparse.ArgumentParser(description='This script converts traces from JSON into csv format.')
	parser.add_argument('benjsonfile', action='store', help='path to ben JSON tracefile') 
	parser.add_argument('maljsonfile', action='store', help='path to mal JSON tracefile') 
        parser.add_argument('csvfile', action='store', help='path to output csv file.')
	return parser.parse_args()

def dict_to_list (leave_out, current_dict):
        l = [] # the list to give back
        for item in current_dict:
            if item not in leave_out:
                for i in current_dict[item]:
                    l.append([float(j) for j in i])
                #l.extend([float(i) for i in current_dict[item]])
        return l

def printCSVFormatted(vector, selected, classified):
        retstr = ""
        for i in selected:
            retstr += str(vector[i-1]) + ','
        retstr += classified + '\n'

	return retstr 

def printLibSVMFormatted(vector):
	return '0 '+' '.join([str(pos+1)+':'+str(item) for pos,item in enumerate(vector)]) + '\n'

def printPlainFormatted(vector):
	return ' '.join(map(str,vector))

def main():
	args = help()

        selected_features = [2, 4, 5, 6, 7, 46, 55, 291, 297, 293, 298] # [143, 147, 241, 121, 46, 55, 264] #[12,64,68,145,173,192,241,249] #
        
        with open("../mapping_tight.json",'r') as infile:
            mapping = json.load(infile)

        with open(args.benjsonfile, 'r') as infile:
            ben_json_dict = json.load(infile)

        with open(args.maljsonfile, 'r') as infile:
            mal_json_dict = json.load(infile)

        ben_vector_list = dict_to_list([], ben_json_dict)
        mal_vector_list = dict_to_list([], mal_json_dict)

        #min_max_scaler = preprocessing.MinMaxScaler()
        min_max_scaler = preprocessing.StandardScaler()
        ben_vector_list = min_max_scaler.fit_transform(ben_vector_list)
        mal_vector_list = min_max_scaler.transform(mal_vector_list)

        with open(args.csvfile, 'w') as outfile:
            # first we need to print the labels
            for i in selected_features:
                outfile.write(mapping[i-1] + ',')
            outfile.write('Name\n') 
            for vector in ben_vector_list:
                outfile.write(printCSVFormatted(vector, selected_features, 'benign'))
            
            for vector in mal_vector_list:
                outfile.write(printCSVFormatted(vector, selected_features, 'malicious'))

if __name__ == "__main__":
	main()
